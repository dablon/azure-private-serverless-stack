# ============================================
# Dockerfile - Azure Private Serverless Stack Test Runner
# ============================================

FROM mcr.microsoft.com/powershell:lts-alpine-3.14

# Labels
LABEL maintainer="devops@team.com"
LABEL description="Test environment for Azure Private Serverless Stack"

# ============================================
# Environment Variables
# ============================================
ENV POWERSHELL_TELEMETRY_OPTOUT=1 \
    DOTNET_CLI_TELEMETRY_OPTOUT=1 \
    TERRAFORM_VERSION=1.5.7 \
    AZURE_CLI_VERSION=2.50.0

# ============================================
# Install Dependencies
# ============================================
RUN apk add --no-cache \
    curl \
    git \
    jq \
    unzip \
    bash \
    docker-cli \
    docker-cli-compose

# Install Terraform
RUN curl -fsSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o /tmp/terraform.zip && \
    unzip -o /tmp/terraform.zip -d /usr/local/bin/ && \
    rm /tmp/terraform.zip && \
    terraform version

# Install Azure CLI
RUN curl -fsSL https://aka.ms/InstallAzureCLIDeb | bash

# Install checkov (security scanning)
RUN pip install --no-cache-dir checkov[tfsec]

# Install Pester (PowerShell testing)
RUN pwsh -Command "Install-Module -Name Pester -Force -SkipPublisherCheck -Scope AllUsers -MinimumVersion 5.3.0"

# Install Az module for Azure testing
RUN pwsh -Command "Install-Module -Name Az -Force -SkipPublisherCheck -Scope AllUsers -AllowClobber"

# ============================================
# Working Directory
# ============================================
WORKDIR /app

# ============================================
# Copy Scripts
# ============================================
COPY scripts/ /app/scripts/
COPY tests/ /app/tests/
COPY terraform/ /app/terraform/

# Make scripts executable
RUN chmod +x /app/tests/run-tests.sh 2>/dev/null || true

# ============================================
# Entry Point
# ============================================
ENTRYPOINT ["/bin/bash"]
CMD ["--help"]
